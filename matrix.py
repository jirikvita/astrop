#!/usr/bin/python

import numpy as np

# Petr Baron
# according to https://arxiv.org/pdf/2008.06486.pdf


matrix = np.array([[0.244  , 0.127  , 0.038  , 0.008  , 0.001  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0. , 0.  , 0. ],
                   [0.237  , 0.310  , 0.165  , 0.048  , 0.008  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.051  , 0.260  , 0.368  , 0.204  , 0.053  , 0.006  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.001  , 0.044  , 0.260  , 0.412  , 0.230  , 0.047  , 0.004  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.033  , 0.238  , 0.439  , 0.234  , 0.039  , 0.002  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.   , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.021  , 0.222  , 0.468  , 0.235  , 0.030  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.016  , 0.219  , 0.497  , 0.228  , 0.021  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.012  , 0.212  , 0.529  , 0.220  , 0.013  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.008  , 0.205  , 0.564  , 0.210  , 0.008  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.005  , 0.191  , 0.600  , 0.198  , 0.004  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.003  , 0.174  , 0.637  , 0.187  , 0.002  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.001  , 0.157  , 0.669  , 0.178  , 0.001  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.139  , 0.694  , 0.169  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.126  , 0.712  , 0.163  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.118  , 0.722  , 0.161  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0. , 0.  , 0. ],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.114  , 0.727  , 0.165  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.111  , 0.730  , 0.177  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.104  , 0.727  , 0.178  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.095  , 0.727  , 0.178  , 0.  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.094  , 0.727  , 0.178  , 0.  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.094  , 0.727  , 0.178  , 0.  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.094  , 0.727  , 0.178  , 0.  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.094  , 0.727  , 0.178  , 0.],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.094  , 0.727  , 0.178],
                   [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.094  , 0.727]])

rev_matrix = matrix[::-1]

np.set_printoptions(edgeitems=25, linewidth=200)  # Adjust edgeitems and linewidth as needed
print("Original Matrix:")
print(rev_matrix)
    
import ROOT as ROOT
import array as array

bins = [18.0, 18.1, 18.2, 18.3, 18.4, 18.5, 18.6, 18.7, 18.8, 18.9, 
        19.0, 19.1, 19.2, 19.3, 19.4, 19.5, 19.6, 19.7, 19.8, 19.9, 
        20.0, 20.1, 20.2, 20.3, 20.4, 20.5]
n_bins = len(bins) - 1 


r_matrix = ROOT.TH2D("astro_matrix", "astro_matrix", n_bins, array.array('d', bins), n_bins, array.array('d', bins))

b=[]
for i in range(len(matrix[0])):
    a=[]
    for j in range(len(matrix[1])):    
        r_matrix.SetBinContent(j+1,i+1,matrix[j][i])
        a.append(matrix[j][i])
    b.append(a)

b=np.array(b)

bins = [18.4, 18.5, 18.6, 18.7, 18.8, 18.9, 
        19.0, 19.1, 19.2, 19.3, 19.4, 19.5, 19.6, 19.7, 19.8, 19.9, 
        20.0, 20.1, 20.2, 20.3, 20.4]
n_bins = len(bins) - 1 

r_matrix_short = ROOT.TH2D("astro_matrix_short", "astro_matrix_short", n_bins, array.array('d', bins), n_bins, array.array('d', bins))

c=[]
for i in range(len(matrix[0])-5):
    a=[]
    for j in range(len(matrix[1])-5):    
        r_matrix_short.SetBinContent(j+1,i+1,matrix[j+4][i+4])
        a.append(matrix[j+4][i+4])
    c.append(a)

c=np.array(c)

r_N      = ROOT.TH1D("N", "N", n_bins,  array.array('d', bins))
r_Ncorr  = ROOT.TH1D("Ncorr", "Ncorr", n_bins,  array.array('d', bins))

N=[83143 ,47500 ,28657 ,17843 ,12435 ,8715  ,6050  ,4111  ,2620  ,1691  ,991   ,624   ,372   ,156   ,83    ,24    ,9     ,6     ,0     ,0     ]
Ncorr=[76176 ,44904,26843 ,16970 ,12109 ,8515  ,5939  ,4048  ,2567   ,1664   ,979     ,619     ,373     ,152     ,80       ,23       ,9         ,6         ,0         ,0         ]

for i in range(len(matrix[0])-6):
    r_N.SetBinContent(i+1, N[i])
    r_Ncorr.SetBinContent(i+1, Ncorr[i])

print("")
print(matrix)
print("")
print(b[::-1])
print("")
print(c[::-1])

astro_matrix_short_nooverflow = r_matrix_short.Clone("astro_matrix_short_nooverflow")

r_matrix_short.SetBinContent(21,20,0.094)
r_matrix_short.SetBinContent(0,1,0.23+0.053+0.008+0.001)
r_matrix_short.SetBinContent(0,2,0.053)
r_matrix_short.SetBinContent(0,3,0.004)

r_N_overflow     = r_N.Clone("N_overflow")
r_Ncorr_overflow = r_Ncorr.Clone("Ncorr_overflow")

r_N_overflow.SetBinContent(0,83143)
r_Ncorr_overflow.SetBinContent(0,76176)

rfile = ROOT.TFile("astro.root", "recreate")
rfile.cd()
r_matrix.Write()
r_matrix_short.Write()
astro_matrix_short_nooverflow.Write()
r_N.Write()
r_Ncorr.Write()
r_N_overflow.Write()
r_Ncorr_overflow.Write()
rfile.Close()
